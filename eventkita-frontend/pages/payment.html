<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Konfirmasi Pembayaran</title>
  <link rel="stylesheet" href="../css/style.css"> 
  <style>
    /* --- Gaya CSS yang Anda berikan (untuk kemudahan) --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #343a40; margin: 0; padding: 0; line-height: 1.6; }
    .topnav { background-color: #ffffff; padding: 15px 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
    .topnav a, .topnav button { text-decoration: none; color: #007bff; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; font-weight: 600; cursor: pointer; border: none; background: none; }
    .topnav a:hover, .topnav button:hover { background-color: #f0faff; color: #0056b3; }
    .container { max-width: 600px; margin: 40px auto; padding: 30px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    h2 { color: #007bff; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; font-weight: 600; }
    p { margin-bottom: 10px; }
    p strong { color: #555; display: inline-block; width: 150px; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #343a40; }
    select, input[type="text"] { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    #paymentCodeValue { background-color: #f1f8ff !important; font-weight: bold; color: #333; border: 1px dashed #007bff !important; }
    #paymentCodeDisplay input[type="text"] { margin-top: 0px !important; margin-bottom: 0px; }
    .container button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; font-weight: 700; margin-top: 20px; transition: background-color 0.3s ease; }
    .container button:hover { background-color: #218838; }
    #paymentCodeDisplay button { width: auto; padding: 8px 15px; background-color: #007bff !important; font-size: 0.9em; margin: 0; }
    #paymentCodeDisplay button:hover { background-color: #0056b3 !important; }
    @media (max-width: 768px) { .container { margin: 20px; padding: 20px; } p strong { width: 120px; } }
    
    /* --- GAYA KHUSUS UNTUK MODAL POP-UP --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Latar belakang gelap transparan */
        display: none; /* Default tersembunyi */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        transform: translateY(-50px);
        transition: transform 0.3s ease-in-out;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }
    
    .modal-icon {
        font-size: 3em;
        margin-bottom: 15px;
    }

    .modal-title {
        font-size: 1.4em;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .modal-body p {
        margin: 5px 0;
        color: #555;
    }

    .modal-footer button {
        margin-top: 20px;
        padding: 10px 20px;
        width: auto;
        background-color: #007bff;
        font-size: 1em;
        font-weight: 600;
    }
    .modal-footer button:hover {
        background-color: #0056b3;
    }
    
    /* Warna Modal berdasarkan Status */
    .modal-success .modal-icon { color: #28a745; }
    .modal-error .modal-icon { color: #dc3545; }
    .modal-info .modal-icon { color: #007bff; }
    
  </style>
</head>
<body onload="initializePaymentPage()">
  <nav class="topnav">
    <div><a href="user-dashboard.html">Kembali ke Dashboard</a></div>
    <div><button onclick="userLogout()">Keluar</button></div>
  </nav>

  <div class="container">
    <h2>Detail Pembayaran</h2>
    <p><strong>Kode Referensi:</strong> <span id="paymentRefCode"></span></p>
    <p><strong>Jumlah Total:</strong> Rp <span id="paymentTotalAmount"></span></p>
    <p><strong>Batas Waktu Pembayaran:</strong> <span id="paymentExpiryTime"></span></p>

    <label for="selectPaymentMethod">Pilih Metode Pembayaran</label>
    <select id="selectPaymentMethod" onchange="handlePaymentMethodChange()">
      <option value="QRIS">QRIS (Kode QR)</option>
      <option value="BANK_TRANSFER">Transfer Bank</option>
      <option value="EWALLET">Dompet Digital (E-Wallet)</option>
      <option value="CREDIT_CARD">Kartu Kredit/Debit</option>
    </select>

    <div id="paymentCodeDisplay" style="display: none; margin-top: 20px; padding: 15px; border: 2px solid #007bff; border-radius: 5px; background-color: #f0faff;">
      <p><strong>Kode Pembayaran Anda:</strong></p>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="paymentCodeValue" readonly style="flex: 1; padding: 8px; font-family: monospace; background-color: #fff; border: 1px solid #007bff; border-radius: 3px;">
        <button onclick="copyPaymentCode()" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Salin Kode</button>
      </div>
      <p style="font-size: 12px; color: #6c757d; margin-top: 8px;">Gunakan kode ini untuk menyelesaikan transaksi Anda.</p>
    </div>

    <button onclick="submitPaymentProcess()">Proses Pembayaran</button>
    
    <div id="notificationArea" style="display: none;"></div> 
  </div>

  <div id="statusModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-icon" id="modalIcon"></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button onclick="hideModal()">Tutup</button>
      </div>
    </div>
  </div>
  <script src="../js/api.js"></script> 
  <script>
    // --- UTILITIES MODAL POP-UP ---
    function showModal(title, message, type = 'info', action = null) {
      const modal = document.getElementById('statusModal');
      const icon = document.getElementById('modalIcon');
      const titleEl = document.getElementById('modalTitle');
      const bodyEl = document.getElementById('modalBody');
      const footerEl = modal.querySelector('.modal-footer');

      // Reset kelas dan isi
      modal.className = 'modal-overlay'; 
      footerEl.innerHTML = '';
      
      // Tentukan ikon dan kelas berdasarkan tipe
      let iconHTML = '';
      if (type === 'success') {
          modal.classList.add('modal-success');
          iconHTML = '✅';
      } else if (type === 'error') {
          modal.classList.add('modal-error');
          iconHTML = '❌';
      } else { // info
          modal.classList.add('modal-info');
          iconHTML = 'ℹ️';
      }

      icon.innerHTML = iconHTML;
      titleEl.innerText = title;
      bodyEl.innerHTML = `<p>${message}</p>`;

      // Tentukan tombol Aksi
      const closeButton = document.createElement('button');
      closeButton.innerText = (action === 'redirect') ? 'Lanjut ke Dashboard' : 'Tutup';
      closeButton.onclick = () => {
          if (action === 'redirect') {
              window.location.href = 'user-dashboard.html';
          } else {
              hideModal();
          }
      };
      footerEl.appendChild(closeButton);

      // Tampilkan modal
      modal.classList.add('active');
    }

    function hideModal() {
      document.getElementById('statusModal').classList.remove('active');
    }
    
    // --- Fungsi Otentikasi dan Logout ---
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      if (!token || !user) {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }
    
    function userLogout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      localStorage.removeItem('role');
      window.location.href = 'login.html';
    }
    
    // --- Variabel Global untuk Data Transaksi ---
    let transactionPaymentId;
    let storedPaymentData = null; 
    
    // --- Inisialisasi Halaman Pembayaran ---
    async function initializePaymentPage(){
      if(!checkAuthentication()) {
        return;
      }
      
      const params = new URLSearchParams(window.location.search);
      transactionPaymentId = params.get('paymentId');
      
      if (!transactionPaymentId) {
        // Tampilkan pesan kesalahan di dalam container, karena ini kesalahan setup awal
        document.querySelector('.container').innerHTML = '<p style="color: red; text-align: center;">❌ **Kesalahan**: ID Pembayaran tidak ditemukan di URL.</p>';
        return;
      }
      
      try {
        await loadPaymentDetails(transactionPaymentId);
      } catch (error) {
        // Tampilkan error menggunakan modal
        showModal('Gagal Memuat Data', `Terjadi kesalahan saat memuat detail pembayaran. Silakan coba lagi. <br> Detail: ${error.message}`, 'error');
        document.querySelector('.container').style.display = 'none'; // Sembunyikan konten jika gagal total
      }
      
      handlePaymentMethodChange(); 
    }
    
    // --- Memuat Detail Pembayaran dari API ---
    async function loadPaymentDetails(paymentId) {
      const token = localStorage.getItem('token');
      const apiEndpoint = (typeof API_BASE !== 'undefined' ? API_BASE : 'http://localhost:8888/api') + `/payments/${paymentId}`;

      const response = await fetch(apiEndpoint, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) {
        const errorDetail = await response.text();
        throw new Error(`Gagal memuat detail pembayaran. Status: ${response.status}`);
      }
      
      const payment = await response.json();
      storedPaymentData = payment;

      const bookingData = payment?.booking || payment;
      const totalAmount = payment?.amount || bookingData?.totalAmount || 0;
      
      let expireTime = bookingData?.expireTime || payment?.expireTime;
      if (!expireTime) {
        const now = new Date();
        const expires = new Date(now.getTime() + 30 * 60000); 
        expireTime = expires.toLocaleString('id-ID');
      }
      
      const referenceCode = bookingData?.kodeBoking || payment?.referenceId || bookingData?.id || paymentId;

      document.getElementById('paymentRefCode').innerText = referenceCode || 'N/A';
      document.getElementById('paymentTotalAmount').innerText = totalAmount.toLocaleString('id-ID');
      document.getElementById('paymentExpiryTime').innerText = expireTime || 'N/A';
      
      if (payment?.paymentCode) {
        document.getElementById('paymentCodeValue').value = payment.paymentCode;
      }
    }

    // --- Mengubah Metode Pembayaran ---
    function handlePaymentMethodChange() {
      const selectedMethod = document.getElementById('selectPaymentMethod').value;
      const displayDiv = document.getElementById('paymentCodeDisplay');
      const codeInput = document.getElementById('paymentCodeValue');
      
      hideModal(); // Bersihkan notifikasi sebelumnya

      if (selectedMethod === 'QRIS' || selectedMethod === 'BANK_TRANSFER') {
        displayDiv.style.display = 'block';
        
        if (storedPaymentData?.paymentCode) {
           codeInput.value = storedPaymentData.paymentCode;
        } else {
           codeInput.value = `Kode akan muncul setelah menekan 'Proses Pembayaran'`;
        }
      } else {
        displayDiv.style.display = 'none';
        codeInput.value = ''; 
      }
    }

    // --- Menyalin Kode Pembayaran ---
    function copyPaymentCode() {
      const codeInput = document.getElementById('paymentCodeValue');
      const isReadOnly = codeInput.readOnly;
      codeInput.readOnly = false; 
      
      codeInput.select();
      codeInput.setSelectionRange(0, 99999); 
      document.execCommand('copy');
      
      codeInput.readOnly = isReadOnly; 
      
      // Tampilkan modal sukses
      showModal('Berhasil Disalin!', 'Kode Pembayaran telah berhasil disalin ke clipboard Anda.', 'success');
    }

    // --- Memproses Pembayaran ke API ---
    async function submitPaymentProcess(){
      const selectedMethod = document.getElementById('selectPaymentMethod').value;
      hideModal(); // Bersihkan notifikasi sebelumnya
      
      try {
        const token = localStorage.getItem('token');
        const apiEndpoint = (typeof API_BASE !== 'undefined' ? API_BASE : 'http://localhost:8888/api') + `/payments/${transactionPaymentId}/process`;

        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ paymentMethod: selectedMethod })
        });
        
        if (!response.ok) {
          const err = await response.json();
          const errorMessage = err.message || err.error || 'Terjadi kegagalan saat memproses pembayaran.';
          
          // Tampilkan modal error
          showModal('Gagal Memproses Transaksi', errorMessage, 'error');
          return;
        }
        
        const result = await response.json();
        
        // Kasus: Metode QRIS/Transfer yang menghasilkan kode/nomor VA
        if (result?.paymentCode) {
          document.getElementById('paymentCodeValue').value = result.paymentCode;
          document.getElementById('paymentCodeDisplay').style.display = 'block'; 
          storedPaymentData = result; 
          
          // Tampilkan modal sukses/info dengan kode
          showModal('Pemrosesan Berhasil', 
                    `Silakan salin kode pembayaran di bawah ini dan selesaikan transaksi menggunakan metode **${selectedMethod}**.`, 
                    'info');
          return; 
        }
        
        // Kasus: Pembayaran yang dianggap selesai atau langsung terverifikasi
        
        // Tampilkan modal sukses dan siapkan redirect
        showModal('Pembayaran Berhasil!', 
                  'Transaksi telah berhasil diproses dan dikonfirmasi. Terima kasih.', 
                  'success', 'redirect');

      } catch (e) {
        // Tampilkan modal error sistem
        showModal('Kesalahan Sistem', `Terjadi kesalahan jaringan atau sistem. <br> Detail: ${e.message}`, 'error');
      }
    }
  </script>
</body>
</html>